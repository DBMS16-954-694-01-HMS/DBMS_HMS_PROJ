{% extends 'base.html' %}

{% block title %}Pending Appointments - Admin{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">Pending Appointments</h3>
      <a class="btn btn-secondary" href="{{ url_for('admin.dashboard') }}">Back to Dashboard</a>
    </div>

    {% if rows %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Patient</th>
              <th>Requested</th>
              <th>Time</th>
              <th>Assigned Doctor</th>
              <th>Notes</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r['id'] }}</td>
              <td>{{ r['patient_name'] }}</td>
              <td>{{ r['appointment_datetime'].split(' ')[0] if r['appointment_datetime'] else '' }}</td>
              <td>{{ r['appointment_datetime'].split(' ')[1] if r['appointment_datetime'] and ' ' in r['appointment_datetime'] else '' }}</td>
              <td>{{ r['doctor_name'] or 'Not assigned' }}</td>
              <td>{{ r['actions'] or '-' }}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#frm{{ r['id'] }}">Assign</button>
                <div class="collapse mt-2" id="frm{{ r['id'] }}">
                  <form method="post" action="{{ url_for('admin.confirm_appointment', aid=r['id']) }}" class="row g-2">
                    <div class="col-12">
                      <select name="doctor" class="form-select form-select-sm" required>
                        <option value="">-- select doctor --</option>
                        {% for d in doctors %}
                          <option value="{{ d['doctor_id'] }}" {% if d['doctor_id']|string == (r['doctor_id']|default(''))|string %}selected{% endif %}>Dr. {{ d['f_name'] }} {{ d['l_name'] }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-12 form-check">
                      <input class="form-check-input" type="checkbox" id="edit_dt_{{ r['id'] }}" name="edit_dt" value="1">
                      <label class="form-check-label" for="edit_dt_{{ r['id'] }}">Edit date/time</label>
                    </div>
                    <div class="col-12 collapse" id="dt_fields_{{ r['id'] }}">
                      <div class="d-flex gap-2">
                        <input type="date" name="date" value="{{ r['appointment_datetime'].split(' ')[0] if r['appointment_datetime'] else '' }}" class="form-control form-control-sm">
                        <input type="time" name="time" value="{{ r['appointment_datetime'].split(' ')[1] if r['appointment_datetime'] and ' ' in r['appointment_datetime'] else '' }}" class="form-control form-control-sm">
                      </div>
                    </div>
                    <div class="col-12">
                      <input type="text" name="actions" class="form-control form-control-sm" placeholder="Admin actions/notes" value="{{ r['actions'] or '' }}">
                    </div>
                    <div class="col-12 text-end">
                      <button type="submit" class="btn btn-sm btn-primary">Confirm & Assign</button>
                    </div>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">No pending appointments.</div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // toggle dt_fields when checkbox clicked
  document.querySelectorAll('[id^="edit_dt_"]').forEach(function(cb){
    cb.addEventListener('change', function(){
      var id = this.id.split('_')[2];
      var fields = document.getElementById('dt_fields_' + id);
      if(!fields) return;
      if(this.checked) fields.classList.add('show'); else fields.classList.remove('show');
    });
  });
});
</script>

{% endblock %}
